name: CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: []

    steps:
      - name: Deploy to Ubuntu server over SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          APP_PATH: ${{ secrets.APP_PATH }}
        run: |
          set -x
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ -n "$SSH_PORT" ]; then
            PORT_ARG="-p $SSH_PORT"
          else
            PORT_ARG=""
          fi

          # Tambah host ke known_hosts; jangan gagal walau ssh-keyscan error,
          # supaya error utama terlihat di langkah ssh berikutnya
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          ssh -vvv $PORT_ARG "$SSH_USER@$SSH_HOST" << 'EOF'
            set -e

            cd "$APP_PATH"
            echo "PWD after first cd: $(pwd)"
            echo "Listing after first cd:"
            ls

            # Kalau belum di root repo, coba cari repo laravel12 di dalamnya
            if [ ! -d .git ]; then
              if [ -d laravel12/.git ]; then
                cd laravel12
                echo "Moved into ./laravel12. PWD: $(pwd)"
              elif [ -d Apps/laravel12/.git ]; then
                cd Apps/laravel12
                echo "Moved into ./Apps/laravel12. PWD: $(pwd)"
              fi
            fi

            echo "Final PWD: $(pwd)"
            echo "Final listing:"
            ls

            git remote -v
            git fetch origin
            git reset --hard origin/main
            cp .env.production .env || true
            docker compose pull || true
            docker compose up -d --build
            docker image prune -f
          EOF
