name: CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    needs: []
    env:
      APP_NAME: laravel12

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Ubuntu server over SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -x
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          if [ -n "$SSH_PORT" ]; then
            PORT_ARG="-p $SSH_PORT"
          else
            PORT_ARG=""
          fi

          # Tambah host ke known_hosts; jangan gagal walau ssh-keyscan error,
          # supaya error utama terlihat di langkah ssh berikutnya
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          REMOTE_DIR="~/apps/deploy/$APP_NAME"
          RUN_DIR="~/apps/$APP_NAME"

          # Pastikan folder deploy dan run di server sudah ada
          ssh $PORT_ARG "$SSH_USER@$SSH_HOST" "mkdir -p $REMOTE_DIR $RUN_DIR"

          # Sinkronkan kode dari runner ke server (tanpa perlu git pull di server)
          RSYNC_SSH_OPTS="-i ~/.ssh/id_rsa"
          if [ -n "$SSH_PORT" ]; then
            RSYNC_SSH_OPTS="$RSYNC_SSH_OPTS -p $SSH_PORT"
          fi

          # Sinkronkan kode, tapi jangan sentuh file .env di server
          rsync -az --delete --exclude='.env' -e "ssh $RSYNC_SSH_OPTS" ./ "$SSH_USER@$SSH_HOST:$REMOTE_DIR"

          ssh -vvv $PORT_ARG "$SSH_USER@$SSH_HOST" << EOF
            set -e
            cd $RUN_DIR
            ls
            sudo docker compose build --no-cache
            sudo docker compose up -d
            sudo docker image prune -f
          EOF
